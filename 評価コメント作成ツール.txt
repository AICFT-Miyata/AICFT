このコードは、人事評価の目標と自己申告を基に、過去の評価データから最も適切な上司コメントを検索し、さらにAIで洗練（リライト）して、Googleスプレッドシートに書き戻すシステムを構築しています。

特に専門用語（エンベディング、コサイン類似度など）について、上司にも分かりやすいよう、機能を3つの主要ステップに分けて丁寧に説明します。

📄 人事評価コメント自動生成ツールの説明
🚀 目的
本ツールは、評価者がコメント作成にかける時間と労力を削減し、評価コメントの質と一貫性を向上させることを目的としています。過去の評価データを活用し、最新の**大規模言語モデル（LLM: Llama 3 GGUF）の能力を組み合わせることで、「検索」と「洗練」**を両立させています。

1. 準備段階：環境構築とモデルのロード
この最初の段階は、システム全体を動かすための土台作りです。

1-1. ライブラリのインストールとインポート
内容: Pythonの実行環境（Colab）に、特殊な機能を持ったライブラリ（ツールセット）をインストールし、使用可能にします。

重要なライブラリ:

Sentence-Transformers: 意味検索に不可欠な**「意味ベクトル（エンベディング）」**を生成するAIモデル群。

Llama-cpp-python: 大規模言語モデル（LLM）である Llama 3 を、GPUを使って高速に実行するためのライブラリ。

Gspread / Google Auth: Google Driveとスプレッドシートへのアクセスとデータ読み書きを行うための認証ライブラリ。

1-2. モデルとデータの定義・ロード
内容: 検索とAI洗練に使用するAIモデルをメモリにロードし、検索元の評価データ（DB.csv）を読み込みます。

意味検索モデル: EMBEDDING_MODEL に、日本語に特化したBERTモデル（cl-tohoku/bert-base-japanese-whole-word-masking）をロードします。これは、「単語の並び」ではなく「文章の意味」を理解するための基礎となります。

GGUFモデル: LLAMA_CLIENT に、高性能な Llama 3 8B Instruct モデル（GGUF形式）をロードし、後のリライト処理に備えます。

2. 実行段階：意味検索によるコメント原案の抽出
この段階では、評価者の入力（目標・自己申告）と過去データの中から、意味的に最も近いコメントを特定します。

2-1. データ処理とエンベディング生成 (Function: load_and_embed_data)
エンベディングとは？: 過去の評価データ（目標と自己申告）の文章を、AIが理解できる**「意味ベクトル（数値の並び）」に変換して保存します。これは、文章一つ一つに意味を表す「座標」**を与えるようなイメージです。

処理: 過去の全評価コメント（訓練データ）に対し、事前にこのエンベディング生成を行い、検索の準備をします。

2-2. 検索ロジック (Function: find_best_match_comment)
処理:

評価者がスプレッドシートに入力した新しい目標と自己申告の文章も、同じように「意味ベクトル」に変換します。

この新しいベクトルと、事前に保存しておいた過去の全コメントのベクトルとの距離を計算します。

距離の計算にはコサイン類似度という手法を用います。これは、ベクトルの方向がどれだけ似ているかを測るもので、類似度が高い（値が1.0に近い）ほど、文章の意味が近いと判断されます。

結果: 最も類似度の高い過去の「上司コメント」を原案として抽出します。

3. 実行段階：AI洗練とスプレッドシートへの出力
検索で得られた原案を、高性能なLLMによってブラッシュアップする、このシステムの核心部分です。

3-1. AIによるコメント洗練ロジック (Function: refine_comment_with_ai)
役割: 検索結果（原案）はあくまで過去のコメントです。これを、**入力された目標と自己申告の内容に合わせて、より具体的でパーソナライズされた文章にリライト（洗練）**します。

処理:

LLaMA 3 GGUFモデルに対し、システムプロンプト（「あなたは人事評価の上司コメントを作成するAIです」という役割設定）を与えます。

ユーザープロンプトとして、「目標」「自己申告」「検索で見つかった原案」の3点を提示し、これらの情報を活用して新しいコメントを作成するよう指示します。

モデルはこれらの情報に基づき、建設的なフィードバックを含む新しいコメントを生成します。

3-2. メイン処理 (Function: main_search_and_write)
処理:

Google認証を行い、指定されたスプレッドシート（例: 検索入力シート）に接続します。

スプレッドシートの指定セル（A2とB2）から、目標と自己申告を読み取ります。

上記の**検索（ステップ2）とAI洗練（ステップ3-1）**を実行します。

最終的に洗練されたコメントを、スプレッドシートの指定セル（C2）に、また検索で得られた類似度スコアを（D2）に書き込みます。

まとめ
本システムは、**「意味検索」で過去の知見を効率的に掘り起こし、その結果を「最新のLLM」**で個別の状況に合わせて洗練するという、ハイブリッドなアプローチでコメント作成を支援します。